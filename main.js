(()=>{"use strict";function e(e,t){if(e>=t**2)throw new Error("Некорректный индекс");switch(e){case 0:return"top-left";case t-1:return"top-right";case t**2-t:return"bottom-left";case t**2-1:return"bottom-right";default:return e<t?"top":e%t==0?"left":e%t==t-1?"right":e>t**2-t?"bottom":"center"}}class t{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const a=document.createElement("div");a.classList.add("cell","map-tile",`map-tile-${e(t,this.boardSize)}`),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(a)}this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),r.style.width=`${a.character.health}%`,i.appendChild(r),s.appendChild(i),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{s.removeChild(i),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}removeCellListeners(){this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[]}removeGameListeners(){this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}}const a={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"};class s{constructor(e,t="generic"){if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,"Character"==new.target.name)throw new Error("Создание объекта класса Character запрещено")}}class i extends s{constructor(e){super(e,"bowman"),this.attack=25,this.defence=25,this.moving=2,this.longrange=2}}class r extends s{constructor(e){super(e,"swordsman"),this.attack=40,this.defence=10,this.moving=4,this.longrange=1}}class n extends s{constructor(e){super(e,"magician"),this.attack=10,this.defence=40,this.moving=1,this.longrange=4}}class l extends s{constructor(e){super(e,"vampire"),this.attack=25,this.defence=25,this.moving=2,this.longrange=2}}class h extends s{constructor(e){super(e,"undead"),this.attack=40,this.defence=10,this.moving=4,this.longrange=1}}class o extends s{constructor(e){super(e,"daemon"),this.attack=10,this.defence=40,this.moving=1,this.longrange=4}}class c{constructor(e){this.characters=e}}function d(e){return e.attack=Math.round(Math.max(e.attack,e.attack*(80+e.health)/100)),e.defence=Math.round(Math.max(e.defence,e.defence*(80+e.health)/100)),e.health=Math.min(e.health+80,100),e.level=Math.min(e.level+1,4),e}function m(e,t,a){let s=[];const i=function*(e,t){for(;;){let a=Math.floor(Math.random()*e.length),s=Math.floor(Math.random()*t)+1,i=new(0,e[a])(1);for(let e=2;e<=s;e++)i=d(i);yield i}}(e,t);for(let e=0;e<a;e++)s.push(i.next().value);return new c(s)}class g{constructor(e,t){if(!(e instanceof s))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}function u(e,t,a){let s,i=[],r=0;for(;r<e.characters.length;){if("user"===t)s=Math.floor(Math.random()*a)*a+r;else{if("bot"!==t)throw new Error("Неверно указан тип игрока");s=Math.floor(Math.random()*a)*a+(a-r-1)}null==i.find((e=>e.position===s))&&(i.push(new g(e.characters[r],s)),r++)}return i}function p(e,t,a){const s=[],i=Math.floor(e/a),r=e%a;for(let n=1;n<=t;n++)r-n>=0&&s.push(e-n),r+n<a&&s.push(e+n),i-n>=0&&s.push(e-a*n),i+n<a&&s.push(e+a*n),r-n>=0&&i-n>=0&&s.push(e-a*n-n),r+n<a&&i-n>=0&&s.push(e-a*n+n),r-n>=0&&i+n<a&&s.push(e+a*n-n),r+n<a&&i+n<a&&s.push(e+a*n+n);return s.sort(((e,t)=>e-t))}function S(e,t,a){const s=[],i=Math.floor(e/a);for(let r=1;r<=t;r++)i-r>=0&&s.push(e-a*r),i+r<8&&s.push(e+a*r);return[e,...s].forEach((e=>{const i=e%a;for(let r=1;r<=t;r++)i+r<a&&s.push(e+r),i-r>=0&&s.push(e-r)})),s.sort(((e,t)=>e-t))}function f(){let e=[],a=[],s=[];if(this.gameState.positionedCharacters.forEach((t=>{for(let a=0;a<this.gameState.userTeam.characters.length;a++)t.character.type!==this.gameState.userTeam.characters[a].type||e.includes(t)||e.push(t);for(let e=0;e<this.gameState.computerTeam.characters.length;e++)t.character.type!==this.gameState.computerTeam.characters[e].type||a.includes(t)||a.push(t)})),a.sort(((e,t)=>e.character.attack<t.character.attack?1:e.character.attack>t.character.attack?-1:0)),a.forEach((a=>{e.forEach((e=>{if(S(a.position,a.character.longrange,this.gamePlay.boardSize).includes(e.position)&&"bot"===this.gameState.activePlayer){const i=this.gameState.getPositionCharacter(e.position),r=Math.round(Math.max(a.character.attack-i.character.defence,.1*a.character.attack));s=this.gameState.positionedCharacters.filter((e=>e!==i)),i.character.health=Math.max(i.character.health-r,0),this.gameState.positionedCharacters=s.concat(i),this.gameState.activePlayer="user",this.gamePlay.showDamage(e.position,r).then((()=>{console.log(`компьютер атаковал персонажем ${a.character.type}, цель: ${i.character.type}, урон ${r}, следующий ход пользователя`),0===i.character.health&&(this.gameState.positionedCharacters=this.gameState.positionedCharacters.filter((e=>e!==i)),this.gameState.userTeam.characters.splice(this.gameState.userTeam.characters.indexOf(i.character),1),this.gameState.lastIndex=null,console.log(`смерть персонажа ${i.character.type}`)),this.gamePlay.redrawPositions(this.gameState.positionedCharacters),0===this.gameState.userTeam.characters.length&&t.showMessage("Game Over")}))}}))})),"bot"!==this.gameState.activePlayer);else{let t=[],i=[],r=-1;if(a.forEach((a=>{t=p(a.position,a.character.moving,this.gamePlay.boardSize),this.gameState.positionedCharacters.forEach((e=>{t.includes(e.position)&&t.filter((t=>{e.position}))}));for(let n=0;n<e.length;n++)if(r<0){i=S(e[n].position,a.character.longrange,this.gamePlay.boardSize);for(let e=0;e<t.length;e++)if(i.includes(t[e])){r=t[e],console.log(`компьютер переместил персонажа ${a.character.type} с поз. ${a.position} на поз. ${r}, следующий ход пользователя`),s=this.gameState.positionedCharacters.filter((e=>e!==a)),a.position=r,this.gameState.positionedCharacters=s.concat(a),this.gamePlay.redrawPositions(this.gameState.positionedCharacters),this.gameState.activePlayer="user";break}}})),"bot"===this.gameState.activePlayer){let n=1;t=p(a[0].position,a[0].character.moving,this.gamePlay.boardSize),this.gameState.positionedCharacters.forEach((e=>{t.includes(e.position)&&t.filter((t=>{e.position}))}));for(let t=0;t<e.length;t++)i.push(S(e[t].position,a[0].character.longrange,this.gamePlay.boardSize));for(;r<0;){for(let e=0;e<t.length;e++)if(r<0)for(let l=0;l<i.length;l++)if(Math.abs(t[e]-i[l])===n||Math.abs(t[e]-i[l])===this.gamePlay.boardSize+n-1){r=t[e],console.log(`компьютер переместил персонажа ${a[0].character.type} с поз. ${a[0].position} на поз. ${r}, следующий ход пользователя`),s=this.gameState.positionedCharacters.filter((e=>e!==a[0])),a[0].position=r,this.gameState.positionedCharacters=s.concat(a[0]),this.gamePlay.redrawPositions(this.gameState.positionedCharacters),this.gameState.activePlayer="user";break}n+=1}}}}const C="auto",v="pointer",y="crosshair",P="not-allowed";class L{constructor(e,t,a,s){this.gameLevel=e,this.userTeam=null,this.computerTeam=null,this.positionedCharacters=null,this.lastIndex=t,this.activePlayer=a,this.userWin=s}static from(e){if("object"==typeof e){const t={bowman:i,swordsman:r,magician:n},a={vampire:l,undead:h,daemon:o},s={...t,...a},d=e=>{const t=s[e.type];if(!t)throw new Error("Неизвестный тип");const a=new t(e.level);return a.health=e.health,a.attack=e.attack,a.defence=e.defence,a.moving=e.moving,a.longrange=e.longrange,a},m=new c([]),u=new c([]),p=[];for(const s of e.positionedCharacters){const e=d(s.character);Object.keys(t).includes(e.type)&&m.characters.push(e),Object.keys(a).includes(e.type)&&u.characters.push(e),p.push(new g(e,s.position))}const S=new L;return S.gameLevel=e.gameLevel,S.userTeam=m,S.computerTeam=u,S.positionedCharacters=p,S.lastIndex=e.lastIndex,S.activePlayer=e.activePlayer,S.userWin=e.userWin,S}return null}getPositionCharacter(e){return this.positionedCharacters.find((t=>t.position===e))}}const w=new t;w.bindToDOM(document.querySelector("#game-container"));const b=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),E=new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.charactersNumber=2,this.levelNumber=4,this.userTypes=[i,r,n],this.computerTypes=[l,h,o],this.greenIndex=null,this.redIndex=null,this.gameState=new L(1,null,"user",0)}init(){this.gamePlay.drawUi(Object.values(a)[this.gameState.gameLevel-1]);const e=[];if(1===this.gameState.gameLevel)this.gameState.userTeam=m(this.userTypes,this.levelNumber,this.charactersNumber),e.push(...u(this.gameState.userTeam,"user",this.gamePlay.boardSize));else for(let t=0;t<this.gameState.userTeam.characters.length;t++)this.gameState.positionedCharacters[t].character=d(this.gameState.positionedCharacters[t].character),e.push(this.gameState.positionedCharacters[t]);this.gameState.computerTeam=m(this.computerTypes,this.levelNumber,this.charactersNumber),e.push(...u(this.gameState.computerTeam,"bot",this.gamePlay.boardSize)),console.log("старт уровня ",this.gameState.gameLevel),console.log("команда пользователя: ",this.gameState.userTeam),console.log("команда компьютера: ",this.gameState.computerTeam),this.gameState.positionedCharacters=e,this.gamePlay.redrawPositions(this.gameState.positionedCharacters),this.addingCellListener("Enter"),this.addingCellListener("Leave"),this.addingCellListener("Click"),this.gamePlay.addNewGameListener(this.newGameCall.bind(this)),this.gamePlay.addSaveGameListener(this.saveGameCall.bind(this)),this.gamePlay.addLoadGameListener(this.loadGameCall.bind(this))}addingCellListener(e){const t=this[`onCell${e}`].bind(this);this.gamePlay[`addCell${e}Listener`](t)}charType(e){const t=this.gameState.getPositionCharacter(e);return t?this.gameState.userTeam.characters.includes(t.character)?"user":"bot":null}newGameCall(){this.gamePlay.removeCellListeners(),this.gamePlay.removeGameListeners(),this.gameState=new L(1,null,"user",this.gameState.userWin),this.init()}saveGameCall(){this.stateService.save(this.gameState)}loadGameCall(){const e=this.stateService.load();e?(this.gameState=L.from(e),this.gamePlay.drawUi(Object.values(a)[this.gameState.gameLevel-1]),this.gamePlay.redrawPositions(this.gameState.positionedCharacters),this.gameState.lastIndex&&this.gamePlay.selectCell(this.gameState.lastIndex)):t.showMessage("Нет сохраненных игр")}onCellClick(e){let a,s,i=f.bind(this);if("user"===this.gameState.activePlayer)if(void 0!==this.gameState.getPositionCharacter(e))if("user"===this.charType(e))null!==this.gameState.lastIndex&&this.gamePlay.deselectCell(this.gameState.lastIndex),this.gamePlay.selectCell(e),this.gameState.lastIndex=e;else if(null!==this.redIndex){a=this.gameState.getPositionCharacter(this.gameState.lastIndex);const r=this.gameState.getPositionCharacter(this.redIndex),n=Math.round(Math.max(a.character.attack-r.character.defence,.1*a.character.attack));s=this.gameState.positionedCharacters.filter((e=>e!==r)),r.character.health=Math.max(r.character.health-n,0),this.gameState.positionedCharacters=s.concat(r),this.redIndex=null,this.gamePlay.deselectCell(this.gameState.lastIndex),this.gamePlay.deselectCell(e),this.gameState.activePlayer="bot",this.gamePlay.showDamage(e,n).then((()=>{console.log(`пользователь атаковал персонажем ${a.character.type}, цель: ${r.character.type}, урон ${n}, следующий ход компьютера`),0===r.character.health&&(this.gameState.positionedCharacters=this.gameState.positionedCharacters.filter((e=>e!==r)),this.gameState.lastIndex=null,this.gameState.computerTeam.characters.splice(this.gameState.computerTeam.characters.indexOf(r.character),1),console.log(`смерть персонажа ${r.character.type}`)),this.gamePlay.redrawPositions(this.gameState.positionedCharacters),0===this.gameState.computerTeam.characters.length?(this.gamePlay.removeCellListeners(),t.showMessage("Уровень пройден"),this.gameState.userWin+=1,this.gameState.gameLevel<4?(this.gameState.gameLevel+=1,this.gameState.activePlayer="user",this.gamePlay.removeGameListeners(),this.init()):t.showMessage("Игра завершена. Вы победили!")):i()}))}else t.showError("Недопустимое действие");else"user"===this.gameState.activePlayer&&null!==this.greenIndex?(a=this.gameState.getPositionCharacter(this.gameState.lastIndex),s=this.gameState.positionedCharacters.filter((e=>e!==a)),a.position=e,this.gameState.positionedCharacters=s.concat(a),this.gamePlay.deselectCell(this.gameState.lastIndex),this.gamePlay.deselectCell(e),this.gamePlay.redrawPositions(this.gameState.positionedCharacters),console.log(`пользователь переместил персонажа ${a.character.type} с поз. ${this.gameState.lastIndex} на поз. ${e}, следующий ход компьютера`),this.gameState.lastIndex=e,this.greenIndex=null,this.gameState.activePlayer="bot",i()):t.showError("Недопустимое действие");else alert("Дождитесь хода противника")}onCellEnter(e){let t,a;null!==this.greenIndex&&(this.gamePlay.deselectCell(this.greenIndex),this.greenIndex=null),null!==this.redIndex&&(this.gamePlay.deselectCell(this.redIndex),this.redIndex=null),null!==this.gameState.lastIndex&&(t=this.gameState.getPositionCharacter(this.gameState.lastIndex));const s=this.gameState.getPositionCharacter(e);if(null==s)null!==this.gameState.lastIndex&&"user"===this.gameState.activePlayer&&(p(this.gameState.lastIndex,t.character.moving,this.gamePlay.boardSize).includes(e)?(this.gamePlay.selectCell(e,"green"),this.greenIndex=e,this.gamePlay.setCursor(v)):this.gamePlay.setCursor(P));else{const r=(i=s.character,`${String.fromCodePoint(127894)}${i.level}${String.fromCodePoint(9876)}${i.attack}${String.fromCodePoint(128737)}${i.defence}${String.fromCodePoint(10084)}${i.health}`);this.gamePlay.showCellTooltip(r,e),a=this.charType(e),"user"===this.gameState.activePlayer&&("user"===a?this.gamePlay.setCursor(v):null!==this.gameState.lastIndex&&"bot"===a&&(S(this.gameState.lastIndex,t.character.longrange,this.gamePlay.boardSize).includes(e)?(this.gamePlay.selectCell(e,"red"),this.redIndex=e,this.gamePlay.setCursor(y)):this.gamePlay.setCursor(P)))}var i}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.gamePlay.setCursor(C)}}(w,b);E.init()})();